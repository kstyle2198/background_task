services:
  # Redis ì„œë¹„ìŠ¤:
  redis:
    container_name: prod_redis
    image: redis:7-alpine
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - redis-data:/data
    networks:
      - prod-network
    restart: unless-stopped

  # Celery ì›Œì»¤ ì„œë¹„ìŠ¤
  worker:
    container_name: prod_worker
    build:
      context: .
      dockerfile: Dockerfile.worker
    env_file:
      - ./.env.prod
    environment:
      - CELERY_WORKER_POOL=prefork
      - CELERY_WORKER_LOGLEVEL=info
    networks:
      - prod-network
    restart: unless-stopped
    depends_on:
      - redis

  # FastAPI ì„œë¹„ìŠ¤: gunicorn ì‚¬ìš©
  fastapi:
    container_name: prod_fastapi
    build:
      context: .
      dockerfile: Dockerfile.fastapi
    ports:
      - "8008:8008"
    env_file:
      - ./.env.prod
    networks:
      - prod-network
    restart: unless-stopped
    depends_on:
      - redis

  # ğŸ”¥ Flower ëŒ€ì‹œë³´ë“œ ì„œë¹„ìŠ¤
  flower:
    container_name: prod_flower
    build:
      context: .
      dockerfile: Dockerfile.worker  # workerì™€ ë™ì¼í•œ í™˜ê²½ ì‚¬ìš©
    env_file:
      - ./.env.prod
    # celery ì•±ì´ ìˆëŠ” ìœ„ì¹˜ì— ë”°ë¼ ì•„ë˜ ëª…ë ¹ì–´ì˜ '-A' ë¶€ë¶„ ìˆ˜ì • í•„ìš” (ì˜ˆ: main.celery_app)
    command: celery -A backend.worker.celery_app flower --port=5555 --broker=redis://prod_redis:6379/0
    ports:
      - "5555:5555"
    depends_on:
      - redis
    networks:
      - prod-network
    restart: unless-stopped

# ë„¤íŠ¸ì›Œí¬ ì •ì˜
networks:
  prod-network:
    driver: bridge

# Redis ë°ì´í„° ì˜ì†ì„± ë³¼ë¥¨ ì •ì˜
volumes:
  redis-data:
